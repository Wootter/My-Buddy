<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" type="image/png" href="{{ url_for('static', filename='picture/Logo\'s/Logo Black.png') }}">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.7/dist/chart.umd.min.js"></script>
  <script>
    // Apply theme immediately to prevent flash
    (function() {
      if (localStorage.getItem('lightmode') === 'active') {
        document.documentElement.classList.add('lightmode');
        if (document.body) {
          document.body.classList.add('lightmode');
        } else {
          document.addEventListener('DOMContentLoaded', function() {
            document.body.classList.add('lightmode');
          });
        }
      }
    })();
  </script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/app.js') }}" defer></script>
  <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script>
  <script>
    let robotConnected = false;
    let updateInterval = null;
    let charts = {};

    document.addEventListener('DOMContentLoaded', () => {
      const socket = io();
      
      socket.on('connect', () => {
        console.log('Connected to server');
      });
      
      socket.on('update_sensor_data', async () => {
        if (robotConnected) {
          console.log('Robot sensor data updated, refreshing dashboard...');
          await updateDashboard();
        }
      });

      // Check robot connection status
      async function checkRobotStatus() {
        try {
          const response = await fetch('/api/devices');
          const data = await response.json();
          robotConnected = data.success && data.devices && data.devices.length > 0;
          
          // Check if any device is actually online
          if (data.devices) {
            robotConnected = data.devices.some(d => d.status === 'online');
          }
        } catch (e) {
          robotConnected = false;
          console.error('Error checking robot status:', e);
        }
      }

      // Initial status check
      checkRobotStatus();
      
      // Check status every 30 seconds
      setInterval(checkRobotStatus, 30000);

      async function updateDashboard() {
          try {
              const response = await fetch('/api/latest-readings');
              const data = await response.json();
              if (data.success && data.readings && Object.keys(data.readings).length > 0) {
                  for (const [name, reading] of Object.entries(data.readings)) {
                      const id = 'val-' + name.replace(/ /g, '-');
                      const el = document.getElementById(id);
                      if (el) {
                          el.textContent = `${reading.value} ${reading.unit || ''}`;
                          el.style.transition = 'color 0.3s';
                          el.style.color = '#4ade80';
                          setTimeout(() => el.style.color = '', 1000);
                      }
                  }
              }
          } catch (e) { console.error('Error updating dashboard:', e); }
      }

      // Only setup auto-refresh if robot is connected
      if (robotConnected) {
        updateDashboard();
        updateInterval = setInterval(updateDashboard, 5000);
      }

      // Store updateDashboard globally for other use
      window.updateDashboard = updateDashboard;
    });
  </script>
  <title>Sensor Data</title>
  <style>
    .chart-container {
      position: relative;
      height: 400px;
      margin: 30px 0;
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
    }
    .chart-title {
      font-size: 1.5em;
      margin-bottom: 15px;
      color: var(--text-clr);
    }
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 20px;
      margin: 20px 0;
    }
    .stat-card {
      padding: 20px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 10px;
      text-align: center;
    }
    .stat-value {
      font-size: 2em;
      font-weight: bold;
      color: var(--text-clr);
    }
    .stat-label {
      color: var(--text-clr);
      opacity: 0.8;
      margin-top: 5px;
    }
    .no-data {
      text-align: center;
      padding: 50px;
      color: var(--text-clr);
      opacity: 0.6;
    }
  </style>
</head>
<body>
  <nav id="sidebar">
    <ul>
      <li>
        <span class="logo">My Buddy</span>
        <button onclick=toggleSidebar() id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z"/></svg>
        </button>
      </li>
      <li>
        <a href="/">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M240-200h120v-200q0-17 11.5-28.5T400-440h160q17 0 28.5 11.5T600-400v200h120v-360L480-740 240-560v360Zm-80 0v-360q0-19 8.5-36t23.5-28l240-180q21-16 48-16t48 16l240 180q15 11 23.5 28t8.5 36v360q0 33-23.5 56.5T720-120H560q-17 0-28.5-11.5T520-160v-200h-80v200q0 17-11.5 28.5T400-120H240q-33 0-56.5-23.5T160-200Zm320-270Z"/></svg>
          <span>Home</span>
        </a>
      </li>
      <li class="active">
        <button onclick=toggleSubMenu(this) class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-507h560v-133H200v133Zm0 214h560v-134H200v134Zm0 213h560v-133H200v133Zm40-454v-80h80v80h-80Zm0 214v-80h80v80h-80Zm0 214v-80h80v80h-80Z"/></svg>
          <span>Data</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z"/></svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="/data">Graphs</a></li>
            <li><a href="/data">Sensors</a></li>
            <li><a href="/data">Actuators</a></li>
          </div>
        </ul>
      </li>
      <li>
        <button onclick=toggleSubMenu(this) class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
          <span>Configure</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z"/></svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="/configure">Light sensor</a></li>
            <li><a href="/configure">Temperature sensor</a></li>
            <li><a href="/configure">Humidity sensor</a></li>
            <li><a href="/configure">Motion sensor</a></li>
            <li><a href="/configure">Led-strip</a></li>
          </div>
        </ul>
      </li>
      <li>
        <a href="/profile">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-240v-32q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v32q0 33-23.5 56.5T720-160H240q-33 0-56.5-23.5T160-240Zm80 0h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"/></svg>
          <span>Profile</span>
        </a>
      </li>
      {% if 'user_id' not in session %}
      <li>
        <a href="/login">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-120v-80h280v-560H480v-80h280q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H480Zm-80-160-55-58 102-102H120v-80h327L345-622l55-58 200 200-200 200Z"/></svg>
          <span>Login</span>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>

  <main>
    <div class="container">
      <h1>Sensor Data Dashboard</h1>
      
      <button id="refresh-btn" onclick="refreshData()" style="
        padding: 12px 24px;
        background: var(--base-clr);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 1em;
        cursor: pointer;
        margin-bottom: 20px;
        display: flex;
        align-items: center;
        gap: 8px;
      ">
        <svg id="refresh-icon" xmlns="http://www.w3.org/2000/svg" height="20px" viewBox="0 -960 960 960" width="20px" fill="white">
          <path d="M480-160q-134 0-227-93t-93-227q0-134 93-227t227-93q69 0 132 28.5T720-690v-110h80v280H520v-80h168q-32-56-87.5-88T480-720q-100 0-170 70t-70 170q0 100 70 170t170 70q77 0 139-44t87-116h84q-28 106-114 173t-196 67Z"/>
        </svg>
        <span id="refresh-text">Refresh Data Now</span>
      </button>
      
      {% if sensors %}
          {% for chart in charts %}
          <div class="stat-card">
            <div class="stat-value" id="val-{{ chart.name|replace(' ', '-') }}" style="color: var(--text-clr);">
               {% if chart.data and chart.data|length > 0 %}
                 <span id="val-{{ chart.name|replace(' ', '-') }}-value">{{ chart.data[-1].value }}</span> <span id="val-{{ chart.name|replace(' ', '-') }}-unit">{{ chart.data[-1].unit or '' }}</span>
               {% else %}
                 <span id="val-{{ chart.name|replace(' ', '-') }}-value">--</span> <span id="val-{{ chart.name|replace(' ', '-') }}-unit"></span>
               {% endif %}
            </div>
            <div class="stat-label">{{ chart.name }}</div>
          </div>
          {% endfor %}
        </div>

        {% if charts %}
          {% for chart in charts %}
          <div class="chart-container">
            <h3 class="chart-title">{{ chart.name }} - {{ chart.type|title }}</h3>
            <canvas id="chart-{{ loop.index }}"></canvas>
          </div>
          {% endfor %}

          <script>
            // Refresh data function
            async function refreshData() {
              const btn = document.getElementById('refresh-btn');
              const text = document.getElementById('refresh-text');
              const icon = document.getElementById('refresh-icon');
              
              // Disable button and show loading state
              btn.disabled = true;
              btn.style.opacity = '0.6';
              btn.style.cursor = 'not-allowed';
              text.textContent = 'Fetching from Viam...';
              icon.style.animation = 'spin 1s linear infinite';
              
              try {
                const response = await fetch('/api/viam/fetch-now', {
                  method: 'POST'
                });
                const result = await response.json();
                
                if (result.success) {
                  text.textContent = `✓ Fetched ${result.readings_saved} readings`;
                  setTimeout(() => {
                    // Reload page to show new data
                    window.location.reload();
                  }, 1000);
                } else {
                  text.textContent = '✗ Fetch failed';
                  setTimeout(() => {
                    text.textContent = 'Refresh Data Now';
                    btn.disabled = false;
                    btn.style.opacity = '1';
                    btn.style.cursor = 'pointer';
                    icon.style.animation = '';
                  }, 2000);
                }
              } catch (error) {
                text.textContent = '✗ Error occurred';
                setTimeout(() => {
                  text.textContent = 'Refresh Data Now';
                  btn.disabled = false;
                  btn.style.opacity = '1';
                  btn.style.cursor = 'pointer';
                  icon.style.animation = '';
                }, 2000);
              }
            }
            
            // Add CSS animation for spinning icon
            const style = document.createElement('style');
            style.textContent = `
              @keyframes spin {
                from { transform: rotate(0deg); }
                to { transform: rotate(360deg); }
              }
            `;
            document.head.appendChild(style);
            
            // Chart.js configuration - Load data from server
            const chartData = {{ charts|tojson }};
            
            if (!chartData || chartData.length === 0) {
              console.log('No chart data available');
            } else {
              // Create a unified timeline from all sensor data
              const allTimestamps = new Set();
              chartData.forEach(sensor => {
                if (sensor.data && sensor.data.length > 0) {
                  sensor.data.forEach(d => {
                    allTimestamps.add(d.timestamp);
                  });
                }
              });
              
              // Sort timestamps chronologically
              const sortedTimestamps = Array.from(allTimestamps).sort();
              const sharedLabels = sortedTimestamps.map(ts => {
                const d = new Date(ts);
                return d.toLocaleDateString() + ' ' + d.toLocaleTimeString();
              });
              
              console.log(`Creating ${chartData.length} charts from ${sortedTimestamps.length} timesteps`);
              
              // Create charts with shared X-axis
              chartData.forEach((sensor, index) => {
                try {
                  const canvasEl = document.getElementById(`chart-${index + 1}`);
                  if (!canvasEl) {
                    console.warn(`Canvas element chart-${index + 1} not found`);
                    return;
                  }
                  
                  const ctx = canvasEl.getContext('2d');
                  
                  // Map sensor data to the shared timeline
                  const timestampToValue = {};
                  if (sensor.data && sensor.data.length > 0) {
                    sensor.data.forEach(d => {
                      timestampToValue[d.timestamp] = d.value;
                    });
                  }
                  
                  const values = sortedTimestamps.map(ts => timestampToValue[ts] !== undefined ? timestampToValue[ts] : null);
                  const unit = sensor.data && sensor.data[0] ? sensor.data[0].unit || '' : '';
                  
                  const colors = ['rgb(75, 192, 192)', 'rgb(255, 159, 64)', 'rgb(255, 99, 132)', 'rgb(54, 162, 235)', 'rgb(153, 102, 255)'];
                  const color = colors[index % colors.length];
                  
                  window.charts[sensor.name] = new Chart(ctx, {
                    type: 'line',
                    data: {
                      labels: sharedLabels,
                      datasets: [{
                        label: `${sensor.name} (${unit})`,
                        data: values,
                        borderColor: color,
                        backgroundColor: color.replace('rgb', 'rgba').replace(')', ', 0.2)'),
                        tension: 0.3,
                        fill: true,
                        spanGaps: true,
                        pointRadius: 3,
                        pointHoverRadius: 5
                      }]
                    },
                    options: {
                      responsive: true,
                      maintainAspectRatio: false,
                      interaction: {
                        mode: 'index',
                        intersect: false
                      },
                      plugins: {
                        legend: {
                          display: true,
                          labels: {
                            color: '#e8eaed'
                          }
                        }
                      },
                      scales: {
                        x: {
                          ticks: {
                            color: '#e8eaed',
                            maxTicksLimit: 12
                          },
                          grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                          }
                        },
                        y: {
                          ticks: {
                            color: '#e8eaed'
                          },
                          grid: {
                            color: 'rgba(255, 255, 255, 0.1)'
                          }
                        }
                      }
                    }
                  });
                  console.log(`Chart created for ${sensor.name} with ${values.length} data points`);
                } catch (e) {
                  console.error(`Error creating chart ${index + 1}:`, e);
                }
              });
            }
          </script>
        {% else %}
          <div class="no-data">
            <h3>No sensor data available yet</h3>
            <p>Upload sensor data using the API endpoint or wait for the hourly export to run.</p>
            <p>API endpoint: <code>POST /api/sensor-data/upload</code></p>
          </div>
        {% endif %}
      {% else %}
        <div class="no-data">
          <h3>No sensors configured</h3>
          <p>Add sensors to your account first in the Configure section.</p>
        </div>
      {% endif %}
    </div>
  </main>
</body>
</html>