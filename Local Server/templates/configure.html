<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
  <style>
    .config-container {
      max-width: 900px;
      margin: 0 auto;
      padding: 20px;
    }

    .robot-selector {
      margin-bottom: 30px;
      padding: 15px;
      background: var(--card-bg);
      border-radius: 8px;
      border: 1px solid var(--border-color);
    }

    .robot-selector select {
      padding: 10px;
      border-radius: 5px;
      border: 1px solid var(--border-color);
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 16px;
      cursor: pointer;
      min-width: 250px;
    }

    .sensors-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }

    .sensor-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 8px;
      padding: 20px;
      transition: all 0.3s ease;
    }

    .sensor-card:hover {
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
      border-color: var(--primary-color);
    }

    .sensor-card h3 {
      margin-top: 0;
      color: var(--primary-color);
      font-size: 18px;
    }

    .sensor-type {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 15px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 5px;
      color: var(--text-color);
    }

    .form-group input,
    .form-group select,
    .form-group textarea {
      width: 100%;
      padding: 8px;
      border: 1px solid var(--border-color);
      border-radius: 4px;
      background: var(--input-bg);
      color: var(--text-color);
      font-size: 14px;
      box-sizing: border-box;
    }

    .form-group input:focus,
    .form-group select:focus,
    .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-color);
      box-shadow: 0 0 0 2px rgba(52, 152, 219, 0.1);
    }

    .pin-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 10px;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 15px;
    }

    .btn-save, .btn-reset {
      flex: 1;
      padding: 10px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      font-weight: 500;
      transition: all 0.3s ease;
    }

    .btn-save {
      background: var(--primary-color);
      color: white;
    }

    .btn-save:hover {
      opacity: 0.9;
      transform: translateY(-2px);
    }

    .btn-reset {
      background: var(--border-color);
      color: var(--text-color);
    }

    .btn-reset:hover {
      opacity: 0.8;
    }

    .status-message {
      padding: 10px;
      margin-top: 10px;
      border-radius: 4px;
      font-size: 13px;
      display: none;
    }

    .status-message.success {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
      display: block;
    }

    .status-message.error {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
      display: block;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-secondary);
    }

    .collapse-section {
      margin-bottom: 15px;
    }

    .collapse-title {
      background: var(--border-color);
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-weight: 500;
      user-select: none;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .collapse-title:hover {
      background: var(--border-color-hover, rgba(0,0,0,0.1));
    }

    .collapse-content {
      padding: 10px 0;
      display: none;
    }

    .collapse-content.open {
      display: block;
    }

    .collapse-icon {
      font-size: 12px;
      transition: transform 0.3s ease;
    }

    .collapse-icon.open {
      transform: rotate(180deg);
    }
  </style>
  <script>
    // Apply theme immediately to prevent flash
    (function() {
      if (localStorage.getItem('lightmode') === 'active') {
        document.documentElement.classList.add('lightmode');
        if (document.body) {
          document.body.classList.add('lightmode');
        }
      }
    })();
  </script>
  <script type="text/javascript" src="{{ url_for('static', filename='js/app.js') }}" defer></script>
  <title>Sensor Configuration</title>
</head>
<body>
  <nav id="sidebar">
    <ul>
      <li>
        <span class="logo">My Buddy</span>
        <button onclick=toggleSidebar() id="toggle-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="m313-480 155 156q11 11 11.5 27.5T468-268q-11 11-28 11t-28-11L228-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T468-692q11 11 11 28t-11 28L313-480Zm264 0 155 156q11 11 11.5 27.5T732-268q-11 11-28 11t-28-11L492-452q-6-6-8.5-13t-2.5-15q0-8 2.5-15t8.5-13l184-184q11-11 27.5-11.5T732-692q11 11 11 28t-11 28L577-480Z"/></svg>
        </button>
      </li>
      <li>
        <a href="/">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M240-200h120v-200q0-17 11.5-28.5T400-440h160q17 0 28.5 11.5T600-400v200h120v-360L480-740 240-560v360Zm-80 0v-360q0-19 8.5-36t23.5-28l240-180q21-16 48-16t48 16l240 180q15 11 23.5 28t8.5 36v360q0 33-23.5 56.5T720-120H560q-17 0-28.5-11.5T520-160v-200h-80v200q0 17-11.5 28.5T400-120H240q-33 0-56.5-23.5T160-200Zm320-270Z"/></svg>
          <span>Home</span>
        </a>
      </li>
      <li>
        <button onclick=toggleSubMenu(this) class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M200-120q-33 0-56.5-23.5T120-200v-560q0-33 23.5-56.5T200-840h560q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H200Zm0-507h560v-133H200v133Zm0 214h560v-134H200v134Zm0 213h560v-133H200v133Zm40-454v-80h80v80h-80Zm0 214v-80h80v80h-80Zm0 214v-80h80v80h-80Z"/></svg>
          <span>Data</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z"/></svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="/data">Graphs</a></li>
            <li><a href="/data">Sensors</a></li>
            <li><a href="/data">Actuators</a></li>
          </div>
        </ul>
      </li>
      <li class="active">
        <button onclick=toggleSubMenu(this) class="dropdown-btn">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M200-200h57l391-391-57-57-391 391v57Zm-80 80v-170l528-527q12-11 26.5-17t30.5-6q16 0 31 6t26 18l55 56q12 11 17.5 26t5.5 30q0 16-5.5 30.5T817-647L290-120H120Zm640-584-56-56 56 56Zm-141 85-28-29 57 57-29-28Z"/></svg>
          <span>Configure</span>
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-361q-8 0-15-2.5t-13-8.5L268-556q-11-11-11-28t11-28q11-11 28-11t28 11l156 156 156-156q11-11 28-11t28 11q11 11 11 28t-11 28L508-372q-6 6-13 8.5t-15 2.5Z"/></svg>
        </button>
        <ul class="sub-menu">
          <div>
            <li><a href="/configure">Sensor Pins</a></li>
          </div>
        </ul>
      </li>
      <li>
        <a href="/profile">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-480q-66 0-113-47t-47-113q0-66 47-113t113-47q66 0 113 47t47 113q0 66-47 113t-113 47ZM160-240v-32q0-34 17.5-62.5T224-378q62-31 126-46.5T480-440q66 0 130 15.5T736-378q29 15 46.5 43.5T800-272v32q0 33-23.5 56.5T720-160H240q-33 0-56.5-23.5T160-240Zm80 0h480v-32q0-11-5.5-20T700-306q-54-27-109-40.5T480-360q-56 0-111 13.5T260-306q-9 5-14.5 14t-5.5 20v32Zm240-320q33 0 56.5-23.5T560-640q0-33-23.5-56.5T480-720q-33 0-56.5 23.5T400-640q0 33 23.5 56.5T480-560Zm0-80Zm0 400Z"/></svg>
          <span>Profile</span>
        </a>
      </li>
      {% if 'user_id' not in session %}
      <li>
        <a href="/login">
          <svg xmlns="http://www.w3.org/2000/svg" height="24px" viewBox="0 -960 960 960" width="24px" fill="#e8eaed"><path d="M480-120v-80h280v-560H480v-80h280q33 0 56.5 23.5T840-760v560q0 33-23.5 56.5T760-120H480Zm-80-160-55-58 102-102H120v-80h327L345-622l55-58 200 200-200 200Z"/></svg>
          <span>Login</span>
        </a>
      </li>
      {% endif %}
    </ul>
  </nav>

  <main>
    <div class="config-container">
      <h2>Sensor Pin Configuration</h2>
      <p>Change your sensor pinouts directly in Viam. Select a robot and update pins - changes take effect immediately.</p>

      <div class="robot-selector">
        <label for="robot-select">Select Robot:</label>
        <select id="robot-select" onchange="loadSensors()">
          <option value="">Choose a robot...</option>
        </select>
      </div>

      <div id="sensors-container" class="sensors-grid"></div>
    </div>
  </main>

  <script>
    // Load user's robots on page load
    document.addEventListener('DOMContentLoaded', function() {
      loadRobots();
    });

    async function loadRobots() {
      try {
        const response = await fetch('/api/devices');
        const data = await response.json();
        
        if (data.success && data.devices) {
          const select = document.getElementById('robot-select');
          select.innerHTML = '<option value="">Choose a robot...</option>';
          
          data.devices.forEach(device => {
            const option = document.createElement('option');
            option.value = device.robot_id;
            option.textContent = device.robot_name;
            select.appendChild(option);
          });
        }
      } catch (error) {
        console.error('Error loading robots:', error);
      }
    }

    async function loadSensors() {
      const robotId = document.getElementById('robot-select').value;
      
      if (!robotId) {
        document.getElementById('sensors-container').innerHTML = '';
        return;
      }

      try {
        const response = await fetch(`/api/robot/${robotId}/sensors`);
        const data = await response.json();
        
        if (data.success && data.sensors.length > 0) {
          renderSensors(data.sensors);
        } else {
          document.getElementById('sensors-container').innerHTML = 
            '<div class="empty-state">No sensors found for this robot</div>';
        }
      } catch (error) {
        console.error('Error loading sensors:', error);
        document.getElementById('sensors-container').innerHTML = 
          '<div class="empty-state">Error loading sensors</div>';
      }
    }

    function renderSensors(sensors) {
      const container = document.getElementById('sensors-container');
      container.innerHTML = '';
      
      sensors.forEach(sensor => {
        const sensorCard = createSensorCard(sensor);
        container.appendChild(sensorCard);
      });
    }

    function createSensorCard(sensor) {
      const card = document.createElement('div');
      card.className = 'sensor-card';
      
      card.innerHTML = `
        <h3>${sensor.name}</h3>
        <div class="sensor-type">${sensor.sensor_type || 'Unknown Type'}</div>
        
        <div class="collapse-section">
          <div class="collapse-title" onclick="toggleCollapse(this)">
            GPIO Configuration
            <span class="collapse-icon">â–¼</span>
          </div>
          <div class="collapse-content open">
            <div class="form-group">
              <label>GPIO Pin (BCM):</label>
              <input type="number" class="gpio-pin" placeholder="e.g., 17">
            </div>
          </div>
        </div>

        <div class="collapse-section">
          <div class="collapse-title" onclick="toggleCollapse(this)">
            I2C Configuration
            <span class="collapse-icon">â–¼</span>
          </div>
          <div class="collapse-content">
            <div class="form-group">
              <label>I2C Address:</label>
              <input type="text" class="i2c-address" placeholder="e.g., 0x44">
            </div>
            <div class="form-group">
              <label>I2C Bus:</label>
              <input type="number" class="i2c-bus" placeholder="e.g., 1">
            </div>
          </div>
        </div>

        <div class="collapse-section">
          <div class="collapse-title" onclick="toggleCollapse(this)">
            SPI Configuration
            <span class="collapse-icon">â–¼</span>
          </div>
          <div class="collapse-content">
            <div class="pin-grid">
              <div class="form-group">
                <label>SPI Bus:</label>
                <input type="number" class="spi-bus" placeholder="e.g., 0">
              </div>
              <div class="form-group">
                <label>SPI Device:</label>
                <input type="number" class="spi-device" placeholder="e.g., 0">
              </div>
            </div>
          </div>
        </div>

        <div class="button-group">
          <button class="btn-save" onclick="saveSensorPins(${sensor.id}, this)">Update Pins in Viam</button>
          <button class="btn-reset" onclick="resetSensorForm(this)">Clear</button>
        </div>

        <div class="status-message"></div>
      `;
      
      return card;
    }

    function toggleCollapse(titleElement) {
      const content = titleElement.nextElementSibling;
      const icon = titleElement.querySelector('.collapse-icon');
      
      content.classList.toggle('open');
      icon.classList.toggle('open');
    }

    async function saveSensorPins(sensorId, button) {
      const card = button.closest('.sensor-card');
      const statusMessage = card.querySelector('.status-message');
      
      const pinData = {
        gpio_pin: parseInt(card.querySelector('.gpio-pin').value) || null,
        i2c_address: card.querySelector('.i2c-address').value || null,
        i2c_bus: parseInt(card.querySelector('.i2c-bus').value) || null,
        spi_bus: parseInt(card.querySelector('.spi-bus').value) || null,
        spi_device: parseInt(card.querySelector('.spi-device').value) || null,
      };

      // Remove null values
      Object.keys(pinData).forEach(key => {
        if (pinData[key] === null) {
          delete pinData[key];
        }
      });

      if (Object.keys(pinData).length === 0) {
        showMessage(statusMessage, 'Please enter at least one pin value', 'error');
        return;
      }

      try {
        button.disabled = true;
        button.textContent = 'Updating...';

        const response = await fetch(`/api/sensor/${sensorId}/pins`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(pinData)
        });

        const data = await response.json();

        if (data.success) {
          showMessage(statusMessage, 'Pins updated successfully in Viam! ðŸŽ‰', 'success');
          setTimeout(() => {
            resetSensorForm(button);
          }, 2000);
        } else {
          showMessage(statusMessage, data.error || 'Failed to update pins', 'error');
        }
      } catch (error) {
        console.error('Error updating pins:', error);
        showMessage(statusMessage, 'Error updating pins in Viam', 'error');
      } finally {
        button.disabled = false;
        button.textContent = 'Update Pins in Viam';
      }
    }

    function resetSensorForm(button) {
      const card = button.closest('.sensor-card');
      card.querySelector('.gpio-pin').value = '';
      card.querySelector('.i2c-address').value = '';
      card.querySelector('.i2c-bus').value = '';
      card.querySelector('.spi-bus').value = '';
      card.querySelector('.spi-device').value = '';
      card.querySelector('.status-message').className = 'status-message';
    }

    function showMessage(element, message, type) {
      element.textContent = message;
      element.className = `status-message ${type}`;
      
      setTimeout(() => {
        if (type === 'error') {
          element.className = 'status-message';
        }
      }, 5000);
    }

  </script>
</body>
</html>